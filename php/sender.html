<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sender</title>
</head>
<body>
    <h1>Sender</h1>
    <video id="localVideo" autoplay playsinline muted></video>

    <script>
    const signalingUrl = 'http://localhost:8080/signaling.php';
    const localVideo = document.getElementById('localVideo');
    const peerConnection = new RTCPeerConnection({
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
        ]
    });

    console.log("ICE Servers Configuration:", peerConnection.getConfiguration());

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            localVideo.srcObject = stream;
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
        })
        .catch(error => console.error("Error accessing camera:", error));

    peerConnection.onicecandidate = event => {
        if (event.candidate) {
            console.log("ICE Candidate generated:", event.candidate);
            fetch(signalingUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'candidate', message: event.candidate })
            }).then(() => console.log("ICE candidate sent."))
            .catch(err => console.error("Error sending ICE candidate:", err));
        } else {
            console.log("No more ICE candidates to gather.");
        }
    };

    peerConnection.oniceconnectionstatechange = () => {
        console.log("ICE Connection State:", peerConnection.iceConnectionState);
    };

    peerConnection.createOffer()
        .then(offer => peerConnection.setLocalDescription(offer))
        .then(() => {
            console.log("Local SDP successfully set.");
            return fetch(signalingUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'offer', message: peerConnection.localDescription })
            });
        })
        .then(() => console.log("SDP offer has been sent."))
        .catch(error => console.error("Error creating or sending SDP offer:", error));
    </script>
</body>
</html>
